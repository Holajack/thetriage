# Migration State - Supabase to Convex + Clerk

> **For Claude Handoffs**: Read this file completely when starting a new session. It contains the current migration state and context needed to continue work.

## Quick Status

| Field | Value |
|-------|-------|
| **Current Phase** | 1 - Project Setup (COMPLETE - Ready for merge) |
| **Current Step** | Commit and merge Phase 1 |
| **Last Updated** | 2026-01-22 |
| **Backup Tag** | `v1.7.0-pre-convex-migration` |
| **Backup Branch** | `backup/supabase-v1.7.0` |
| **Convex Project** | hikewise (dev:upbeat-puma-955) |
| **Convex URL** | https://upbeat-puma-955.convex.cloud |

---

## Progress Tracker

### Phase 1: Project Setup
- [x] Create backup tag (v1.7.0-pre-convex-migration)
- [x] Create backup branch (backup/supabase-v1.7.0)
- [x] Create MIGRATION_STATE.md
- [x] Create Phase 1 branch (migration/convex-phase-1-setup)
- [x] Install convex dependency (v1.31.6)
- [x] Install @clerk/clerk-expo dependency (v2.19.19)
- [x] Install expo-secure-store dependency (v15.0.8)
- [x] Install expo-auth-session and expo-web-browser (Clerk peer deps)
- [x] Initialize Convex project (`npx convex dev`)
- [x] Update .env with Clerk placeholder
- [x] Verify app still builds
- [x] Test existing functionality unchanged
- **Status**: COMPLETE
- **Blockers**: None

### Phase 2: Clerk Auth Integration
- [ ] Create Clerk account and application
- [ ] Get EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY
- [ ] Create ClerkProvider.tsx
- [ ] Create ConvexClientProvider.tsx
- [ ] Update App.tsx with providers
- [ ] Rewrite LoginScreen.tsx for Clerk
- [ ] Rewrite ForgotPasswordScreen.tsx for Clerk
- [ ] Rewrite ResetPasswordScreen.tsx for Clerk
- [ ] Rewrite EmailVerificationScreen.tsx for Clerk
- [ ] Rewrite AccountCreationScreen.tsx for Clerk
- [ ] Update RootNavigator.tsx for Clerk auth
- [ ] Update app.json deep linking
- [ ] Test all auth flows
- **Status**: Not Started
- **Blockers**: None

### Phase 3: Convex Schema & Functions
- [ ] Create convex/schema.ts (20 tables)
- [ ] Create convex/users.ts
- [ ] Create convex/tasks.ts
- [ ] Create convex/subtasks.ts
- [ ] Create convex/friends.ts
- [ ] Create convex/messages.ts
- [ ] Create convex/studyRooms.ts
- [ ] Create convex/focusSessions.ts
- [ ] Create convex/leaderboard.ts
- [ ] Create convex/achievements.ts
- [ ] Create convex/settings.ts
- [ ] Create convex/onboarding.ts
- [ ] Create convex/http.ts (Clerk webhook)
- [ ] Verify schema deploys without errors
- **Status**: Not Started
- **Blockers**: None

### Phase 4: React Hooks Migration
- [ ] Create src/hooks/useConvex.ts
- [ ] Convert useSupabaseProfile
- [ ] Convert useSupabaseTasks
- [ ] Convert useSupabaseLeaderboard
- [ ] Convert useSupabaseFocusSession
- [ ] Convert useFocusSessionHistory
- [ ] Convert useSupabaseAchievements
- [ ] Convert useSupabaseFriends
- [ ] Convert useSupabaseStudyRooms
- [ ] Convert useSupabaseSubjects
- [ ] Convert useSupabaseInsights
- [ ] Convert useSupabaseSubtasks
- [ ] Convert useUserAppData
- [ ] Update all screens to use new hooks
- **Status**: Not Started
- **Blockers**: None

### Phase 5: Real-time Migration
- [ ] Convert subscribeToConversation
- [ ] Convert subscribeToMessageNotifications
- [ ] Update messagingService.ts
- [ ] Update studyRoomService.ts
- [ ] Test real-time messages
- [ ] Test real-time study room updates
- **Status**: Not Started
- **Blockers**: None

### Phase 6: Edge Functions to Convex Actions
- [ ] Create convex/noraChat.ts action
- [ ] Create convex/patrickChat.ts action
- [ ] Create convex/transcribe.ts action
- [ ] Add OPENAI_API_KEY to Convex env
- [ ] Update NoraScreen.tsx
- [ ] Update NoraScreenNew.tsx
- [ ] Update PatrickScreen.tsx
- [ ] Update FloatingNoraChatbot.tsx
- [ ] Test AI chat functionality
- **Status**: Not Started
- **Blockers**: None

### Phase 7: Cleanup & Supabase Removal
- [ ] Remove @supabase/supabase-js dependency
- [ ] Delete src/utils/supabase.ts
- [ ] Delete src/utils/supabaseHooks.ts
- [ ] Delete src/context/AuthContext.tsx
- [ ] Delete supabase/ directory
- [ ] Remove Supabase env variables
- [ ] Update app.json (remove associatedDomains)
- [ ] Verify no Supabase references remain
- [ ] Final testing
- **Status**: Not Started
- **Blockers**: None

---

## Files Modified This Phase

| File | Change Type | Description |
|------|-------------|-------------|
| package.json | Modify | Added convex (v1.31.6), @clerk/clerk-expo (v2.19.19), expo-secure-store (v15.0.8), expo-auth-session, expo-web-browser |
| package-lock.json | Modify | Updated with 166 new packages |
| .env | Modify | Added EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY placeholder |
| .env.local | Create | Auto-created by Convex with CONVEX_DEPLOYMENT and EXPO_PUBLIC_CONVEX_URL |
| convex/ | Create | Auto-generated by npx convex dev |
| convex/_generated/ | Create | Auto-generated TypeScript types for Convex |
| MIGRATION_STATE.md | Create | Context preservation file for Claude handoffs |

---

## Environment Variables Needed

```env
# Existing (keep until Phase 7)
EXPO_PUBLIC_SUPABASE_URL=<existing>
EXPO_PUBLIC_SUPABASE_ANON_KEY=<existing>
OPENAI_API_KEY=<existing>

# New - Phase 1
EXPO_PUBLIC_CONVEX_URL=<from Convex dashboard after init>

# New - Phase 2
EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY=<from Clerk dashboard>
```

---

## Git State

| Item | Value |
|------|-------|
| Pre-migration tag | `v1.7.0-pre-convex-migration` |
| Backup branch | `backup/supabase-v1.7.0` |
| Current branch | `migration/convex-phase-1-setup` |
| Phase 1 branch | `migration/convex-phase-1-setup` (active) |

---

## Rollback Instructions

### Emergency Rollback (abort migration)
```bash
git checkout v1.7.0-pre-convex-migration
rm -rf node_modules convex/
npm install
```

### Rollback to specific phase
```bash
git checkout v1.7.0-convex-phase-{N}-complete
rm -rf node_modules
npm install
```

---

## Known Issues

None currently.

---

## Notes for Next Claude Session

1. **Plan file location**: `/Users/jackenholland/.claude/plans/glowing-churning-turing.md`
2. **Testing checklist**: `/Users/jackenholland/AppDev/thetriage/docs/migration/TESTING_CHECKLIST.md`
3. **Full migration plan**: `/Users/jackenholland/AppDev/thetriage/docs/migration/CONVEX_CLERK_MIGRATION_PLAN.md`
4. **LLM prompts reference**: `/Users/jackenholland/AppDev/thetriage/docs/migration/LLM_PROMPTS.md`

**Key constraints**:
- NO version changes (Expo SDK 54.0.0, App version 1.7.0)
- NO frontend UI changes
- Each phase must be tested before merging
- Full rollback capability at every phase

**Current task**: Complete Phase 1 - Install dependencies and initialize Convex

---

*Last updated by Claude session on 2026-01-22*
